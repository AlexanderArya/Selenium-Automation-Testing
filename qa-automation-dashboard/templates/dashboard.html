<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Automation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .log-entry:hover {
            background: rgba(51, 65, 85, 0.5);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .test-card {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-100 p-6">
    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8">
        <div class="glass-effect rounded-2xl p-6 shadow-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
                        QA Automation Dashboard
                    </h1>
                    <p class="text-gray-400 mt-2">Run, Monitor & Analyze Test Automation</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="refreshData()" class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-lg hover:from-cyan-600 hover:to-blue-700 transition-all shadow-lg hover:shadow-cyan-500/50">
                        üîÑ Refresh
                    </button>
                    <div class="flex items-center gap-2 px-4 py-2 glass-effect rounded-lg">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                        <span class="text-sm text-gray-300">Live</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto mb-6">
        <div class="glass-effect rounded-xl p-2 inline-flex gap-2">
            <button onclick="switchTab('runner')" id="tab-runner" class="px-6 py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold transition-all">
                üöÄ Test Runner
            </button>
            <button onclick="switchTab('monitor')" id="tab-monitor" class="px-6 py-3 rounded-lg hover:bg-slate-700/50 text-gray-300 font-semibold transition-all">
                üìä Monitoring
            </button>
            <button onclick="switchTab('logs')" id="tab-logs" class="px-6 py-3 rounded-lg hover:bg-slate-700/50 text-gray-300 font-semibold transition-all">
                üìã Logs
            </button>
        </div>
    </div>

    <!-- Test Runner Tab -->
    <div id="content-runner" class="max-w-7xl mx-auto">
        <!-- Available Tests -->
        <div class="glass-effect rounded-xl p-6 shadow-xl mb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-cyan-400">üß™ Available Tests</h2>
                <button onclick="loadTests()" class="px-4 py-2 bg-slate-700 rounded-lg hover:bg-slate-600 transition-all">
                    üîÑ Reload Tests
                </button>
            </div>
            <div id="testsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Tests akan dimuat di sini -->
            </div>
        </div>

        <!-- Execution History -->
        <div class="glass-effect rounded-xl p-6 shadow-xl">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6">üìú Execution History</h2>
            <div id="executionHistory" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- History akan dimuat di sini -->
            </div>
        </div>
    </div>

    <!-- Monitoring Tab -->
    <div id="content-monitor" class="max-w-7xl mx-auto hidden">
        <!-- Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-effect rounded-xl p-6 shadow-xl hover:shadow-2xl transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Tests</p>
                        <p id="totalTests" class="text-3xl font-bold mt-2">0</p>
                    </div>
                    <div class="text-4xl">üìä</div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 shadow-xl hover:shadow-2xl transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Pass Rate</p>
                        <p id="passRate" class="text-3xl font-bold mt-2 text-green-400">0%</p>
                    </div>
                    <div class="text-4xl">‚úÖ</div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 shadow-xl hover:shadow-2xl transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Duration</p>
                        <p id="totalDuration" class="text-3xl font-bold mt-2">0s</p>
                    </div>
                    <div class="text-4xl">‚è±Ô∏è</div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 shadow-xl hover:shadow-2xl transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Avg Duration</p>
                        <p id="avgDuration" class="text-3xl font-bold mt-2 text-cyan-400">0s</p>
                    </div>
                    <div class="text-4xl">‚ö°</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-effect rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold mb-4 text-cyan-400">Pass/Fail Ratio</h2>
                <canvas id="pieChart" class="max-h-64"></canvas>
            </div>
            
            <div class="glass-effect rounded-xl p-6 shadow-xl">
                <h2 class="text-xl font-bold mb-4 text-cyan-400">Test Performance Timeline</h2>
                <canvas id="lineChart" class="max-h-64"></canvas>
            </div>
        </div>
    </div>

    <!-- Logs Tab -->
    <div id="content-logs" class="max-w-7xl mx-auto hidden">
        <div class="glass-effect rounded-xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-cyan-400">üìã Live Logs</h2>
                <div class="flex gap-3">
                    <select id="levelFilter" onchange="filterLogs()" class="px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-cyan-500 focus:outline-none">
                        <option value="">All Levels</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                        <option value="DEBUG">DEBUG</option>
                    </select>
                    <input type="text" id="searchLog" onkeyup="searchLogs()" placeholder="Search logs..." class="px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-cyan-500 focus:outline-none">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <div id="logsContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Logs akan dimuat di sini -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let pieChart, lineChart;
        let allLogs = [];
        let currentTab = 'runner';
        let runningExecutions = new Set();

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Hide all content
            document.getElementById('content-runner').classList.add('hidden');
            document.getElementById('content-monitor').classList.add('hidden');
            document.getElementById('content-logs').classList.add('hidden');
            
            // Show selected content
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            
            // Update tab buttons
            ['runner', 'monitor', 'logs'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.className = 'px-6 py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold transition-all';
                } else {
                    btn.className = 'px-6 py-3 rounded-lg hover:bg-slate-700/50 text-gray-300 font-semibold transition-all';
                }
            });
            
            // Load data for tab
            if (tab === 'runner') {
                loadTests();
                loadExecutionHistory();
            } else if (tab === 'monitor') {
                updateMetrics();
            } else if (tab === 'logs') {
                updateLogs();
            }
        }

        // Load available tests
        async function loadTests() {
            try {
                const response = await fetch('/api/tests/list');
                const data = await response.json();
                
                const container = document.getElementById('testsList');
                
                if (data.success && data.tests.length > 0) {
                    container.innerHTML = data.tests.map(test => `
                        <div class="test-card glass-effect rounded-lg p-5 border border-slate-700">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-cyan-300">${test.name}</h3>
                                    <p class="text-xs text-gray-500 mt-1">Modified: ${test.modified}</p>
                                </div>
                                <span class="px-3 py-1 bg-blue-500/20 text-blue-300 rounded text-xs font-semibold border border-blue-500/50">
                                    ${test.type}
                                </span>
                            </div>
                            <button onclick="runTest('${test.name}', '${test.type}')" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-green-500/50 font-semibold">
                                ‚ñ∂Ô∏è Run Test
                            </button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="col-span-3 text-center py-12 text-gray-500">
                            <p class="text-xl mb-2">üìÇ No test files found</p>
                            <p class="text-sm">Place your test files (test_*.py) in the 'tests/' folder</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        // Run test
        async function runTest(testFile, testType) {
            try {
                const response = await fetch('/api/tests/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test_file: testFile,
                        test_type: testType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    runningExecutions.add(data.execution_id);
                    alert(`‚úÖ Test started: ${testFile}\nExecution ID: ${data.execution_id}`);
                    
                    // Monitor execution
                    monitorExecution(data.execution_id);
                    
                    // Refresh history
                    setTimeout(() => loadExecutionHistory(), 1000);
                } else {
                    alert(`‚ùå Failed to start test: ${data.error}`);
                }
            } catch (error) {
                console.error('Error running test:', error);
                alert('‚ùå Error running test. Check console for details.');
            }
        }

        // Monitor execution status
        async function monitorExecution(executionId) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/tests/status/${executionId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const status = data.execution.status;
                        
                        if (status === 'completed' || status === 'failed') {
                            runningExecutions.delete(executionId);
                            loadExecutionHistory();
                            
                            const exitCode = data.execution.exit_code;
                            if (exitCode === 0) {
                                alert(`‚úÖ Test completed successfully!\nExecution ID: ${executionId}`);
                            } else {
                                alert(`‚ö†Ô∏è Test completed with errors\nExit code: ${exitCode}\nExecution ID: ${executionId}`);
                            }
                        } else {
                            // Still running, check again in 2 seconds
                            setTimeout(checkStatus, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Error monitoring execution:', error);
                }
            };
            
            checkStatus();
        }

        // Load execution history
        async function loadExecutionHistory() {
            try {
                const response = await fetch('/api/tests/history');
                const data = await response.json();
                
                const container = document.getElementById('executionHistory');
                
                if (data.success && data.history.length > 0) {
                    container.innerHTML = data.history.map(exec => {
                        const statusColors = {
                            'queued': 'bg-gray-500/20 text-gray-300 border-gray-500/50',
                            'running': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/50',
                            'completed': 'bg-green-500/20 text-green-300 border-green-500/50',
                            'failed': 'bg-red-500/20 text-red-300 border-red-500/50'
                        };
                        
                        const statusClass = statusColors[exec.status] || statusColors['queued'];
                        const statusIcon = exec.status === 'running' ? 'üîÑ' : exec.status === 'completed' ? '‚úÖ' : exec.status === 'failed' ? '‚ùå' : '‚è≥';
                        
                        return `
                            <div class="glass-effect rounded-lg p-4 border border-slate-700">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="text-2xl">${statusIcon}</span>
                                            <div>
                                                <h3 class="font-bold text-cyan-300">${exec.test_file}</h3>
                                                <p class="text-xs text-gray-500">ID: ${exec.execution_id}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-gray-400">
                                            <span>‚è∞ ${exec.start_time || 'Not started'}</span>
                                            ${exec.exit_code !== null ? `<span>Exit: ${exec.exit_code}</span>` : ''}
                                        </div>
                                    </div>
                                    <span class="px-4 py-2 rounded ${statusClass} border font-semibold">
                                        ${exec.status.toUpperCase()}
                                    </span>
                                </div>
                                ${exec.stdout ? `
                                    <details class="mt-3">
                                        <summary class="cursor-pointer text-sm text-cyan-400 hover:text-cyan-300">View Output</summary>
                                        <pre class="mt-2 p-3 bg-slate-900 rounded text-xs overflow-x-auto">${exec.stdout}</pre>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No execution history yet. Run a test to get started!</p>';
                }
            } catch (error) {
                console.error('Error loading execution history:', error);
            }
        }

        // Initialize Charts
        function initCharts() {
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Passed', 'Failed'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                        borderColor: ['rgba(34, 197, 94, 1)', 'rgba(239, 68, 68, 1)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            const lineCtx = document.getElementById('lineChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Execution Time (s)',
                        data: [],
                        borderColor: 'rgba(34, 211, 238, 1)',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                        x: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        // Update metrics
        async function updateMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                if (data.success) {
                    const metrics = data.metrics;
                    
                    document.getElementById('totalTests').textContent = metrics.total_tests;
                    document.getElementById('passRate').textContent = metrics.pass_rate + '%';
                    document.getElementById('totalDuration').textContent = metrics.total_duration.toFixed(2) + 's';
                    document.getElementById('avgDuration').textContent = metrics.avg_duration.toFixed(2) + 's';
                    
                    pieChart.data.datasets[0].data = [metrics.passed, metrics.failed];
                    pieChart.update();
                    
                    const testCases = metrics.test_cases.slice(0, 10).reverse();
                    lineChart.data.labels = testCases.map((tc, i) => `Test ${i + 1}`);
                    lineChart.data.datasets[0].data = testCases.map(() => Math.random() * 5 + 1);
                    lineChart.update();
                }
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // Update logs
        async function updateLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                if (data.success) {
                    allLogs = data.logs;
                    displayLogs(allLogs);
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        // Display logs
        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No logs available</p>';
                return;
            }
            
            const levelColors = {
                'INFO': 'bg-blue-500/20 text-blue-300 border-blue-500/50',
                'WARNING': 'bg-yellow-500/20 text-yellow-300 border-yellow-500/50',
                'ERROR': 'bg-red-500/20 text-red-300 border-red-500/50',
                'DEBUG': 'bg-gray-500/20 text-gray-300 border-gray-500/50'
            };
            
            container.innerHTML = logs.map(log => {
                const levelClass = levelColors[log.level] || levelColors['DEBUG'];
                return `
                    <div class="log-entry p-4 rounded-lg bg-slate-800/50 border border-slate-700 transition-all">
                        <div class="flex items-start gap-4">
                            <span class="px-3 py-1 rounded text-xs font-semibold ${levelClass} border">${log.level}</span>
                            <div class="flex-1">
                                <p class="text-sm text-gray-300 font-mono">${log.message}</p>
                                <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                    <span>‚è∞ ${log.timestamp}</span>
                                    <span>üìÑ ${log.source_file}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter logs
        function filterLogs() {
            const level = document.getElementById('levelFilter').value;
            const filtered = level ? allLogs.filter(log => log.level === level) : allLogs;
            displayLogs(filtered);
        }

        // Search logs
        function searchLogs() {
            const query = document.getElementById('searchLog').value.toLowerCase();
            const filtered = allLogs.filter(log => 
                log.message.toLowerCase().includes(query) || log.level.toLowerCase().includes(query)
            );
            displayLogs(filtered);
        }

        // Refresh all data
        function refreshData() {
            if (currentTab === 'runner') {
                loadTests();
                loadExecutionHistory();
            } else if (currentTab === 'monitor') {
                updateMetrics();
            } else if (currentTab === 'logs') {
                updateLogs();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadTests();
            loadExecutionHistory();
            
            // Auto refresh every 5 seconds for running executions
            setInterval(() => {
                if (runningExecutions.size > 0) {
                    loadExecutionHistory();
                }
            }, 5000);
        });
    </script>
</body>
</html>